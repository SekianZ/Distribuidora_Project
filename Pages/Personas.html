<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Usuarios</title>
    <link rel="stylesheet" href="/Estilos/estilo.css">


    <script>
        // Variables de estado
        let contrase√±aVisible = false;
        let enModoEdicion = false;

        function manejarClicExterno(event) {
            const popup = document.getElementById("popup");
            if (event.target === popup) {
                cerrarPopup();
            }
        }

        // Funci√≥n para mostrar popup de nuevo usuario
        function mostrarPopup() {
            enModoEdicion = false;
            document.getElementById("popup").style.display = "block";
            document.getElementById("popupBackdrop").style.display = "block";
            document.addEventListener('click', manejarClicExterno);
            limpiarFormulario();
            document.getElementById("contrase√±a").readOnly = false; // Permitir edici√≥n en nuevo
        }


        function cerrarPopup() {
            document.getElementById("popup").style.display = "none";
            // Asegurarse de ocultar el backdrop tambi√©n
            if (document.getElementById("popupBackdrop")) {
                document.getElementById("popupBackdrop").style.display = "none";
            }
            document.removeEventListener('click', manejarClicExterno);
            limpiarFormulario();
        }


        function enviarFormulario(event) {
            event.preventDefault();
            var formData = new FormData(document.getElementById("formUsuario"));

            fetch("procesar_usuario.php", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.text())
                .then(data => {
                    alert(data);
                    cerrarPopup();
                    location.reload();
                })
                .catch(error => console.error("Error:", error));
        }

        // Funci√≥n para mostrar popup de edici√≥n
        function mostrarPopupEditar(idUsuario, nombreUsuario, permiso, contrase√±a) {
            document.getElementById("idUsuario").value = idUsuario;
            document.getElementById("nombreUsuario").value = nombreUsuario;
            document.getElementById("permiso").value = permiso;

            // Mostrar contrase√±a real (sin cifrado)
            const contrase√±aInput = document.getElementById("contrase√±a");
            contrase√±aInput.value = contrase√±a; // Mostramos el texto plano
            contrase√±aInput.type = 'password'; // Ocultamos por defecto

            document.getElementById("popup").style.display = "block";
            document.getElementById("popupBackdrop").style.display = "block";
        }


        function confirmarEliminacion(idUsuario) {
            if (confirm("¬øEst√°s seguro de que deseas eliminar este usuario?")) {
                fetch("eliminar_usuario.php", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: "idUsuario=" + idUsuario
                    })
                    .then(response => response.text())
                    .then(data => {
                        alert(data);
                        location.reload();
                    })
                    .catch(error => console.error("Error:", error));
            }
        }

        // Funci√≥n para limpiar el formulario
        function limpiarFormulario() {
            document.getElementById("formUsuario").reset();
            document.getElementById("idUsuario").value = "";
            const contrase√±aInput = document.getElementById("contrase√±a");
            contrase√±aInput.value = "";
            contrase√±aInput.type = 'password';
            contrase√±aInput.readOnly = false;
            document.getElementById("toggleContrase√±a").textContent = 'üëÅÔ∏è';
            contrase√±aVisible = false;
            enModoEdicion = false;
        }

        // Funci√≥n para alternar visibilidad de contrase√±a

        function toggleContrase√±a() {
            const contrase√±aInput = document.getElementById("contrase√±a");
            const toggleBtn = document.getElementById("toggleContrase√±a");

            if (contrase√±aInput.type === 'password') {
                contrase√±aInput.type = 'text';
                toggleBtn.textContent = 'üôà';
            } else {
                contrase√±aInput.type = 'password';
                toggleBtn.textContent = 'üëÅÔ∏è';
            }
        }
        // Inicializar el evento del bot√≥n
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById("toggleContrase√±a").addEventListener('click', toggleContrase√±a);
        });
    </script>
    <style>
        #popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <button onclick="mostrarPopup()" id="btnNuevo">Nuevo Usuario</button>
    <div class="popup-backdrop" id="popupBackdrop"></div>
    <div id="popup">
        <h2>Permiso</h2>
        <form id="formUsuario" onsubmit="enviarFormulario(event)">
            <input type="hidden" id="idUsuario" name="idUsuario">
            <div class="form-group">
                <label for="nombreUsuario">Nombre:</label>
                <input type="text" id="nombreUsuario" name="nombreUsuario" required>
            </div>
            <div class="form-group">
                <label for="contrase√±a">Contrase√±a:</label>
                <div class="password-wrapper">
                    <input type="password" id="contrase√±a" name="contrase√±a">
                    <button type="button" id="toggleContrase√±a" class="toggle-password">üëÅÔ∏è</button>
                </div>
            </div>
            <div class="form-group">
                <label for="permiso">Permiso:</label>
                <select id="permiso" name="permiso">
                    <option value="Administrador">Administrador</option>
                    <option value="Supervisor">Supervisor</option>
                    <option value="Contador">Contador</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn-primary">Guardar</button>
                <button type="button" class="btn-secondary" onclick="cerrarPopup()">Cancelar</button>
            </div>
        </form>
    </div>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Permiso</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

</body>

</html>